<%- content_for :content_width do -%>content-wide<%- end -%>
<%- content_for :hide_widgets do -%>please do not display widgets!!!<%- end -%>
<div class="content-submenu">
  <em>Events</em> | World Kabbalah Conventio 2010
</div>
<div class="content-stream event-stream">
  <div class="admin">
 		<%= render_widget(:stream_admin) %>
  </div>
  <div class="tabs">
    <span class="active"><%= link_to 'Stream', '#', :remote => true %></span>
    <span><%= link_to 'Gallery', '#', :remote => true %></span>
    <span class="admin-link"><%= link_to 'Admin', '#', :onclick => "$('.admin').toggle(); return false;" %></span>
  </div>
  <div class="bgnd">
    <div class="support">
      <span style="color:green">ONLINE!</span><br/>
      <a href="#">Technical Support</a>
    </div>
    <div class="player">
      <object width="400" height="305" data="http://switch3.castup.net/cunet/gm.asp?ClipMediaID=160788" name="player" id="player" type="video/x-ms-wmv">
        <param value="http://switch3.castup.net/cunet/gm.asp?ClipMediaID=160788" name="src"/>
        <param value="true" name="autostart"/>
        <param value="true" name="controller"/>
        <param value="50" name="volume"/>
        <param value="full" name="uiMode"/>
        <param value="true" name="animationAtStart"/>
        <param value="false" name="showDisplay"/>
        <param value="true" name="ShowAudioControls"/>
        <param value="false" name="ShowPositionControls"/>
        <param value="false" name="transparentAtStart"/>
        <param value="true" name="ShowControls"/>
        <param value="true" name="ShowStatusBar"/>
        <param value="false" name="ShowTracker"/>
        <param value="false" name="ClickToPlay"/>
        <param value="#000000" name="DisplayBackColor"/>
        <param value="#ffffff" name="DisplayForeColor"/>
        <param value="false" name="balance"/>
      </object>
      <form action="#" method="get" accept-charset="utf-8">
        <p>
          <% if user_signed_in?
            suffix = ''
          else
            suffix = '/users/login'
          end
          locale = I18n.locale.to_s
        %>
          <select name="language" id="language" onchange="alert('language')">
            <% Language.all.each { |l| %>
              <option <%= 'selected="selected"'.html_safe if l.locale == locale %> value="<%= root_path(l.locale) + suffix %>"><%= l.language %></option>
            <% } %>
          </select>
        </p>
      </form>
      <form action="#" method="get" accept-charset="utf-8">
        <p>
          <select name="quality" id="quality" onchange="alert('quality')">
            <option>Israel - Hiqh Quality</option>
            <option>Israel - Medium Quality</option>
            <option>Israel - Low Quality</option>
            <option>USA - Hiqh Quality</option>
            <option>USA - Medium Quality</option>
            <option>USA - Low Quality</option>
          </select>
        </p>
      </form>
    </div>
    <div class="services">
      <div class="tabs">
        <span><%= link_to 'Questions', '#', :remote => true %></span>
        <span><%= link_to 'Schedule', '#', :remote => true %></span>
        <span class="active"><%= link_to 'Sketches', '#', :remote => true %></span>
      </div>
      <div class="content">
        <div class="images">
        </div>
        <div class="buttons">
          <a class="left_button" href="#" onclick="first(); return false;">&laquo; First</a>
          <a class="left_button" href="#" onclick="prev(); return false;">&lsaquo; Prev</a>
          <span class="title"></span>
          <a class="right_button" href="#" onclick="last(); return false;">Last &raquo;</a>
          <a class="right_button" href="#" onclick="next(); return false;">Next &rsaquo;</a>
          <div class="clear"></div>
          <a id="new_sketches" class="right_button hidden" href="#" onclick="last(); return false;">There are new sketches &raquo;</a>
          <div class="clear"></div>
        </div>
      </div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="clear"></div>
</div>
<script type="text/javascript">
  var total = 0,
  $current = 0,
  $images,
  $first,
  $last,
  $in_transition = false;

  var pollID = 0;
  var pollSketches = function() {
    $.ajax({
      url: 'event_data/classboard',
      data: {
        lang: 'English',
        total: total
      },
      success: transit_init
    });
  }
  
  $(function (){
    pollSketches();
    startPollingSketches();
  });

  function startPollingSketches(){
    pollID = setInterval(pollSketches, 30000);
  }
  
  function stopPollingSketches(){
    clearInterval(pollID);
    pollID = 0;
  }

  function transit_init(data){
    $images = $('.content .images img');
    if (total == 0 && $images.length > 0) { // The first time some images were added
      total = $images.length;
      $last = $current = $images.last();
      $first = $images.first();
      $last.css('z-index', 10); // Become the upper for sure
      $('.title').text(total + '/' + total);
    } else if (total != 0 && total != $images.length) { // Only if more images are here now
      total = $images.length;
      $last = $images.last();
      $('.title').text(($current.index() + 1) + '/' + total);
      $('#new_sketches').show();
    }
  }

  function first(){
    transit_to($first);
  }

  function last(){
    transit_to($last);
    $('#new_sketches').hide();
  }

  function prev(){
    $item = $current.prev();
    transit_to($item);
  }

  function next(){
    $item = $current.next();
    transit_to($item);
  }

  function transit_to($item){
    if (total <= 1 || $item.length == 0 || $current === $item || $in_transition) return;
    $in_transition = true;

    $item.css('z-index', 9); // Beneath the upper one
    $('.title').text(($item.index() + 1) + '/' + total);
    $current.animate({opacity: 0}, 1000, 'linear', // Hide the upper one
    function(){
      $item.css('z-index', 10); // Become the upper
      $current.css({'z-index': 1, 'opacity': 1}); // Go back
      $current = $item;
      $in_transition = false;
    }
  );
  }

</script>